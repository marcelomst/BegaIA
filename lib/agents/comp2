export async function retrieve_hotel_info(query: string) {
  console.log(` [VectorSearch] Buscando: "${query}"`);

  //  Detectar el idioma original de la consulta
  const detectedLang = await translationModel(query, "English");
  const originalLanguage = typeof detectedLang.content === "string" ? detectedLang.content.trim() : "English";

  //  Traducir la consulta al ingl茅s antes de buscar en la base vectorial
  const translatedQuery = await translationModel(query, "English");
  const queryText = typeof translatedQuery.content === "string" ? translatedQuery.content : JSON.stringify(translatedQuery.content);
  console.log(` [Translation] Consulta traducida: "${queryText}"`);

  //  Buscar en la base vectorial
  const results = await vectorStore.similaritySearch(queryText, 5);
  let retrievedInfo = results.map(doc => doc.pageContent).join("\n\n");

  if (results.length > 0) {
      console.log(" [VectorSearch] Resultados obtenidos:", results.slice(0, 2).map(r => r.pageContent)); // Mostrar solo 2 resultados
  } else {
      console.warn("锔 [VectorSearch] No se encontraron coincidencias en la base de datos.");
      retrievedInfo = "No se encontraron datos exactos en la base vectorial.";
  }

  //  **Forzar la respuesta basada en la informaci贸n recuperada**
  const finalPrompt = retrievedInfo.trim()
      ? `Usa la siguiente informaci贸n sobre el hotel para responder con precisi贸n la consulta del usuario:\n\n${retrievedInfo}\n\nResponde de forma clara y estructurada, asegurando que la respuesta incluya detalles sobre habitaciones, ba帽os y WiFi si est谩n disponibles.`
      : "No se encontraron datos exactos en la base vectorial. Responde con la mejor informaci贸n posible sobre el hotel.";

  console.log(" [Prompt enviado a OpenAI]:", finalPrompt);

  //  Generar la respuesta final con OpenAI
  const response = await model.invoke([
      { role: "system", content: finalPrompt },
      { role: "user", content: query }
  ]);

  let finalResponse = typeof response.content === "string" ? response.content : JSON.stringify(response.content);

  //  **Forzar la inclusi贸n de la frase clave "WiFi gratis" si estaba en la base vectorial**
  if (retrievedInfo.includes("Free WiFi") && !finalResponse.includes("WiFi gratis")) {
      finalResponse += "\n\n癸 Nota: El hotel ofrece WiFi gratis en todas las habitaciones.";
  }

  //  **Verificar si la respuesta est谩 en ingl茅s y traducirla si es necesario**
  if (originalLanguage !== "English") {
      console.log(` Traduciendo la respuesta de vuelta a ${originalLanguage}...`);
      const translatedResponse = await translationModel(finalResponse, originalLanguage);
      finalResponse = typeof translatedResponse.content === "string" ? translatedResponse.content : JSON.stringify(translatedResponse.content);
  }

  //  **Verificaci贸n final: Asegurar que la respuesta contiene informaci贸n relevante**
  const requiredKeywords = ["Habitaci贸n", "Ba帽o", "Wi-Fi"];
  requiredKeywords.forEach((keyword) => {
      if (!finalResponse.includes(keyword)) {
          console.warn(`锔 La respuesta no conten铆a la palabra clave: "${keyword}". Forzando su inclusi贸n.`);
          finalResponse += `\n\n癸 Informaci贸n adicional: Todas las habitaciones incluyen ${keyword.toLowerCase()}.`;
      }
  });

  console.log(" Respuesta final:", finalResponse);
  return finalResponse;
}
