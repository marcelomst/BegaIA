# Path: /root/begasist/docker-compose.cloudflared.yml
version: "3.9"

services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: begasist-cloudflared
    restart: unless-stopped

    # Corre explícitamente como el mismo uid/gid que ya vimos en runtime
    user: "65532:65532"

    # Métricas (local) + logs un poco más verbosos para diagnosticar
    command: >
      tunnel --no-autoupdate
      --loglevel info
      --metrics 0.0.0.0:2000
      --config /etc/cloudflared/config.yml
      run mi-tunel-begasist

    volumes:
      - /root/begasist/.cloudflared:/etc/cloudflared:ro

    networks:
      - begasist_net

    # Healthcheck simple contra /metrics (ayuda a detectar caídas del túnel)
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:2000/metrics >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  begasist_net:
    external: true
